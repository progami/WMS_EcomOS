# Manual Deployment Commands for WMS Application
# Execute these commands after connecting to your EC2 instance via SSH
# SSH command: ssh -i your-key.pem ubuntu@3.87.244.116

# 1. Set variables
DEPLOYMENT_DIR="/var/www/wms"
S3_BUCKET="wms-deployment-1751383624"
PACKAGE_NAME="wms-built-minimal.tar.gz"
APP_NAME="wms"

# 2. Create deployment directory
sudo mkdir -p $DEPLOYMENT_DIR
sudo chown ubuntu:ubuntu $DEPLOYMENT_DIR

# 3. Download package from S3
cd /tmp
aws s3 cp s3://$S3_BUCKET/$PACKAGE_NAME .

# 4. Extract package
cd $DEPLOYMENT_DIR
tar -xzf /tmp/$PACKAGE_NAME

# 5. Install production dependencies only
npm ci --production

# 6. Create environment file
cat > .env << 'EOL'
NODE_ENV=production
PORT=3000
DATABASE_URL=postgresql://wms_user:wms_password@localhost:5432/wms_db
NEXTAUTH_SECRET=$(openssl rand -base64 32)
NEXTAUTH_URL=http://localhost:3000
JWT_SECRET=$(openssl rand -base64 32)
EOL

# 7. Run database migrations
export DATABASE_URL="postgresql://wms_user:wms_password@localhost:5432/wms_db"
npx prisma migrate deploy

# 8. Setup PM2
pm2 delete wms 2>/dev/null || true

# 9. Create PM2 ecosystem file
cat > ecosystem.config.js << 'EOL'
module.exports = {
  apps: [{
    name: 'wms',
    script: 'npm',
    args: 'start',
    cwd: '/var/www/wms',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: '/var/log/pm2/wms-error.log',
    out_file: '/var/log/pm2/wms-out.log',
    log_file: '/var/log/pm2/wms-combined.log'
  }]
};
EOL

# 10. Create log directory
sudo mkdir -p /var/log/pm2
sudo chown ubuntu:ubuntu /var/log/pm2

# 11. Start application
pm2 start ecosystem.config.js

# 12. Save PM2 configuration
pm2 save

# 13. Setup PM2 startup
sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u ubuntu --hp /home/ubuntu

# 14. Check status
pm2 status
pm2 logs --lines 20

# 15. Clean up
rm -f /tmp/$PACKAGE_NAME

# Application should now be running on port 3000
# To check logs: pm2 logs wms
# To restart: pm2 restart wms
# To stop: pm2 stop wms