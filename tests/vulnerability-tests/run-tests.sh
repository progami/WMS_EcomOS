#!/bin/bash

echo "========================================"
echo "WMS Vulnerability Test Suite"
echo "========================================"
echo ""
echo "These tests demonstrate critical vulnerabilities in the WMS application."
echo "ALL TESTS ARE EXPECTED TO FAIL - this indicates vulnerabilities exist."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to run test category
run_test_category() {
    local category=$1
    local description=$2
    
    echo -e "${YELLOW}Testing: $description${NC}"
    echo "----------------------------------------"
    
    npx jest $category --passWithNoTests 2>&1 | while IFS= read -r line; do
        if [[ $line == *"FAIL"* ]]; then
            echo -e "${RED}$line${NC}"
        elif [[ $line == *"PASS"* ]]; then
            echo -e "${GREEN}$line${NC}"
        else
            echo "$line"
        fi
    done
    
    echo ""
}

# Check if specific category requested
if [ $# -eq 0 ]; then
    echo "Running all vulnerability tests..."
    echo ""
    
    run_test_category "race-conditions/" "Race Condition Vulnerabilities"
    run_test_category "auth-security/" "Authentication & Authorization Vulnerabilities"
    run_test_category "financial-calculations/" "Financial Calculation Vulnerabilities"
    run_test_category "data-validation/" "Data Validation & Security Vulnerabilities"
    run_test_category "memory-performance/" "Memory & Performance Edge Cases"
    run_test_category "api-integration/" "API Integration Failures"
    
    echo -e "${YELLOW}Running E2E tests with Playwright...${NC}"
    echo "----------------------------------------"
    npx playwright test e2e-edge-cases/
else
    # Run specific category
    run_test_category "$1" "$1"
fi

echo ""
echo "========================================"
echo "Test Summary"
echo "========================================"
echo "If tests FAILED - vulnerabilities exist (expected)"
echo "If tests PASSED - vulnerabilities have been fixed"
echo ""
echo "See VULNERABILITY_SUMMARY.md for details"